<%args>
$location
$trial_id => undef
</%args>

<%doc>
Weather widget for trial detail page.
Shows two summary panels + interactive D3 chart:
  1. Hydrological year (Sep year-1 ‚Üí Sep year) ‚Äî annual precipitation/GDD
  2. Growing season (planting ‚Üí harvest) ‚Äî GDD/CHU during crop growth
  3. Chart: temperature range, daily precip bars, cumulative GDD line
</%doc>

<%init>
my $location_id;
my $planting_date;
my $harvest_date;
my $year;

if ($trial_id) {
    my $dbh = $c->dbc->dbh;

    ($location_id) = $dbh->selectrow_array(
        "SELECT DISTINCT nd.nd_geolocation_id
         FROM nd_experiment nd
         JOIN nd_experiment_project ep ON nd.nd_experiment_id = ep.nd_experiment_id
         WHERE ep.project_id = ? LIMIT 1",
        undef, $trial_id
    );

    ($planting_date) = $dbh->selectrow_array(
        "SELECT pp.value FROM projectprop pp
         JOIN cvterm c ON pp.type_id = c.cvterm_id
         WHERE pp.project_id = ? AND c.name = 'project_planting_date'",
        undef, $trial_id
    );
    ($harvest_date) = $dbh->selectrow_array(
        "SELECT pp.value FROM projectprop pp
         JOIN cvterm c ON pp.type_id = c.cvterm_id
         WHERE pp.project_id = ? AND c.name = 'project_harvest_date'",
        undef, $trial_id
    );

    # Parse dates: ISO (2024-05-10T00:00:00) or word-month (2024-May-10)
    my %months = (
        January => '01', February => '02', March => '03',
        April   => '04', May      => '05', June  => '06',
        July    => '07', August   => '08', September => '09',
        October => '10', November => '11', December  => '12',
    );
    for my $d (\$planting_date, \$harvest_date) {
        next unless $$d;
        if ($$d =~ /(\d{4})-(\d{2})-(\d{2})T/) { $$d = "$1-$2-$3"; }
        elsif ($$d =~ /(\d{4})-([A-Za-z]+)-(\d{1,2})/) {
            my $m = $months{$2} || '01';
            $$d = sprintf('%s-%s-%02d', $1, $m, $3);
        } else { $$d = undef; }
    }

    if ($planting_date && $planting_date =~ /^(\d{4})/) { $year = $1; }
}

my $hydro_start = $year ? ($year - 1) . '-09-01' : '';
my $hydro_end   = $year ? "${year}-09-01" : '';
</%init>

<div id="trial_weather_widget">
  <p id="trial_weather_check"><i class="glyphicon glyphicon-refresh spinning"></i> –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö...</p>

  <div id="trial_weather_summary" style="display:none">

    <!-- Row 1: Hydrological Year -->
    <div class="panel panel-default" style="margin-bottom:8px">
      <div class="panel-heading" style="padding:6px 12px">
        <strong>üìÖ –ì–æ–¥–æ–≤–æ–π –≤–æ–¥–Ω—ã–π –±–∞–ª–∞–Ω—Å</strong>
        <small class="text-muted pull-right" id="tw_hydro_period"></small>
      </div>
      <div class="panel-body" style="padding:10px">
        <div class="row text-center">
          <div class="col-xs-4">
            <h4 style="color:#3498db;margin:4px 0"><span id="tw_hydro_precip">‚Äî</span> <small>–º–º</small></h4>
            <small class="text-muted">–û—Å–∞–¥–∫–∏ –∑–∞ –≥–æ–¥</small>
          </div>
          <div class="col-xs-4">
            <h4 style="color:#e67e22;margin:4px 0"><span id="tw_hydro_gdd">‚Äî</span></h4>
            <small class="text-muted">GDD –∑–∞ –≥–æ–¥</small>
          </div>
          <div class="col-xs-4">
            <h4 style="color:#2ecc71;margin:4px 0"><span id="tw_hydro_chu">‚Äî</span></h4>
            <small class="text-muted">CHU –∑–∞ –≥–æ–¥</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 2: Growing Season -->
    <div class="panel panel-default" style="margin-bottom:8px">
      <div class="panel-heading" style="padding:6px 12px">
        <strong>üå± –í–µ–≥–µ—Ç–∞—Ü–∏–æ–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</strong>
        <small class="text-muted pull-right" id="tw_season_period"></small>
      </div>
      <div class="panel-body" style="padding:10px">
        <div class="row text-center">
          <div class="col-xs-3">
            <h4 style="color:#e67e22;margin:4px 0"><span id="tw_season_gdd">‚Äî</span></h4>
            <small class="text-muted">GDD (base 10¬∞C)</small>
          </div>
          <div class="col-xs-3">
            <h4 style="color:#2ecc71;margin:4px 0"><span id="tw_season_chu">‚Äî</span></h4>
            <small class="text-muted">CHU</small>
          </div>
          <div class="col-xs-3">
            <h4 style="color:#3498db;margin:4px 0"><span id="tw_season_precip">‚Äî</span> <small>–º–º</small></h4>
            <small class="text-muted">–û—Å–∞–¥–∫–∏</small>
          </div>
          <div class="col-xs-3">
            <h4 style="color:#8e44ad;margin:4px 0"><span id="tw_season_days">‚Äî</span></h4>
            <small class="text-muted">–î–Ω–µ–π</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Row 3: Chart -->
    <div class="panel panel-default" style="margin-bottom:8px">
      <div class="panel-heading" style="padding:6px 12px">
        <strong>üìä –ü–æ–≥–æ–¥–∞ –∑–∞ –≤–µ–≥–µ—Ç–∞—Ü–∏—é</strong>
        <div class="btn-group btn-group-xs pull-right" role="group">
          <button type="button" class="btn btn-default tw-chart-btn active" data-mode="temp">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</button>
          <button type="button" class="btn btn-default tw-chart-btn" data-mode="precip">–û—Å–∞–¥–∫–∏</button>
          <button type="button" class="btn btn-default tw-chart-btn" data-mode="gdd">GDD</button>
        </div>
      </div>
      <div class="panel-body" style="padding:4px">
        <div id="tw_chart_container" style="width:100%; height:280px; position:relative;"></div>
      </div>
    </div>

    <div style="margin-top:8px">
      <a id="tw_export_hydro" href="#" class="btn btn-sm btn-success" style="margin-right:4px" download>
        <span class="glyphicon glyphicon-download-alt"></span> Excel: –≥–æ–¥–æ–≤–æ–π (—Å–µ–Ω—Ç.‚Üí—Å–µ–Ω—Ç.)
      </a>
      <a id="tw_export_season" href="#" class="btn btn-sm btn-primary" style="margin-right:4px" download>
        <span class="glyphicon glyphicon-download-alt"></span> Excel: –≤–µ–≥–µ—Ç–∞—Ü—ñ—è
      </a>
      <a href="/tools/weather/gdd" class="btn btn-sm btn-default">
        <span class="glyphicon glyphicon-stats"></span> GDD/CHU –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      </a>
    </div>
  </div>
</div>

<style>
.spinning { animation: spin 1s linear infinite; }
@keyframes spin { 100% { transform: rotate(360deg); } }
.tw-chart-btn.active { background: #337ab7; color: #fff; }
.tw-tooltip {
  position: absolute; pointer-events: none;
  background: rgba(0,0,0,.82); color: #fff;
  padding: 6px 10px; border-radius: 4px;
  font-size: 11px; line-height: 1.5;
  z-index: 100; white-space: nowrap;
}
</style>

<script type="text/javascript" defer="defer">
jQuery(document).ready(function() {
  var locationId    = "<% $location_id || '' %>";
  var plantingDate  = "<% $planting_date || '' %>";
  var harvestDate   = "<% $harvest_date || '' %>";
  var hydroStart    = "<% $hydro_start %>";
  var hydroEnd      = "<% $hydro_end %>";
  var trialLocation = "<% $location %>";

  if (!locationId) {
    jQuery('#trial_weather_check').html('<p><i>–õ–æ–∫–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. </i><a href="/tools/weather/gdd">GDD –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a></p>');
    return;
  }
  if (!plantingDate || !harvestDate) {
    jQuery('#trial_weather_check').html('<p><i>–ù–µ —É–∫–∞–∑–∞–Ω—ã –¥–∞—Ç—ã –ø–æ—Å–µ–≤–∞/—É–±–æ—Ä–∫–∏. </i><a href="/tools/weather/gdd">GDD –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a></p>');
    return;
  }

  var completed = 0, errors = 0;
  var seasonData = null;

  // Set Excel export URLs
  var exportBase = '/ajax/weather/export?location_id=' + locationId + '&base_temp=10';
  jQuery('#tw_export_hydro').attr('href', exportBase + '&start_date=' + hydroStart + '&end_date=' + hydroEnd);
  jQuery('#tw_export_season').attr('href', exportBase + '&start_date=' + plantingDate + '&end_date=' + harvestDate);

  function checkDone() {
    if (completed >= 2) {
      if (errors >= 2) {
        jQuery('#trial_weather_check').html('<p><i>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏. </i><a href="/tools/weather/gdd">GDD –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä</a></p>');
      } else {
        jQuery('#trial_weather_check').hide();
        jQuery('#trial_weather_summary').show();
        // Defer chart render; also handle case where parent panel is collapsed
        if (seasonData) scheduleChartRender();
      }
    }
  }

  // Tries to render the chart; retries up to 5 times if container has 0 width
  var chartRendered = false;
  function scheduleChartRender() {
    if (chartRendered) return;
    var attempts = 0;
    var interval = setInterval(function() {
      attempts++;
      var w = jQuery('#tw_chart_container').width();
      if (w > 50) {
        clearInterval(interval);
        chartRendered = true;
        drawChart(seasonData, 'temp');
      } else if (attempts >= 10) {
        clearInterval(interval);
      }
    }, 200);
  }

  // Also re-render when the parent Bootstrap collapse panel opens
  jQuery(document).on('shown.bs.collapse', function(e) {
    var panel = jQuery(e.target);
    if (panel.find('#tw_chart_container').length && seasonData && !chartRendered) {
      scheduleChartRender();
    }
  });

  // === Request 1: Hydrological Year ===
  jQuery.ajax({
    url: '/ajax/weather/gdd', type: 'POST',
    data: { location_id: locationId, base_temp: 10,
      seasons: JSON.stringify([{ year: parseInt(hydroEnd.substring(0,4)), start_date: hydroStart, end_date: hydroEnd }])
    },
    dataType: 'json',
    success: function(r) {
      if (r.success && r.days_count > 0) {
        jQuery('#tw_hydro_precip').text(r.total_precip);
        jQuery('#tw_hydro_gdd').text(r.total_gdd);
        jQuery('#tw_hydro_chu').text(r.total_chu);
        jQuery('#tw_hydro_period').text(hydroStart + ' ‚Üí ' + hydroEnd + ' (' + r.days_count + ' –¥–Ω.)');
      }
      completed++; checkDone();
    },
    error: function() { completed++; errors++; checkDone(); }
  });

  // === Request 2: Growing Season ===
  jQuery.ajax({
    url: '/ajax/weather/gdd', type: 'POST',
    data: { location_id: locationId, base_temp: 10,
      seasons: JSON.stringify([{ year: parseInt(plantingDate.substring(0,4)), start_date: plantingDate, end_date: harvestDate }])
    },
    dataType: 'json',
    success: function(r) {
      if (r.success && r.days_count > 0) {
        jQuery('#tw_season_gdd').text(r.total_gdd);
        jQuery('#tw_season_chu').text(r.total_chu);
        jQuery('#tw_season_precip').text(r.total_precip);
        jQuery('#tw_season_days').text(r.days_count);
        jQuery('#tw_season_period').text(plantingDate + ' ‚Üí ' + harvestDate);
        seasonData = r.daily_data || [];
      }
      completed++; checkDone();
    },
    error: function() { completed++; errors++; checkDone(); }
  });

  // === Chart toggle buttons ===
  jQuery(document).on('click', '.tw-chart-btn', function() {
    jQuery('.tw-chart-btn').removeClass('active');
    jQuery(this).addClass('active');
    if (seasonData) drawChart(seasonData, jQuery(this).data('mode'));
  });

  // === D3 Chart Renderer ===
  function drawChart(data, mode) {
    var container = d3.select('#tw_chart_container');
    container.selectAll('*').remove();

    if (!data || !data.length) return;

    var parseDate = d3.timeParse('%Y-%m-%d');
    data.forEach(function(d) { d._date = parseDate(d.date); });

    var margin = {top: 16, right: 52, bottom: 28, left: 46};
    // Use jQuery width (reliable after show) + known height from CSS
    var totalW = jQuery('#tw_chart_container').width() || 700;
    var totalH = 280;
    var W = totalW - margin.left - margin.right;
    var H = totalH - margin.top - margin.bottom;

    var svg = container.append('svg')
      .attr('width', totalW).attr('height', totalH)
      .append('g').attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');

    var xScale = d3.scaleTime()
      .domain(d3.extent(data, function(d) { return d._date; }))
      .range([0, W]);

    var xAxis = d3.axisBottom(xScale).ticks(6).tickFormat(d3.timeFormat('%d.%m'));
    svg.append('g').attr('transform', 'translate(0,' + H + ')').call(xAxis)
      .selectAll('text').style('font-size', '10px');

    // Tooltip
    var tooltip = container.append('div').attr('class', 'tw-tooltip').style('display', 'none');

    if (mode === 'temp') {
      // Temperature range area + avg line
      var yMin = d3.min(data, function(d) { return +d.tmin; }) - 2;
      var yMax = d3.max(data, function(d) { return +d.tmax; }) + 2;
      var yScale = d3.scaleLinear().domain([yMin, yMax]).range([H, 0]);

      svg.append('g').call(d3.axisLeft(yScale).ticks(6)).selectAll('text').style('font-size','10px');
      svg.append('text').attr('transform', 'rotate(-90)').attr('y', -36).attr('x', -H/2)
        .attr('text-anchor', 'middle').style('font-size', '11px').text('¬∞C');

      // Temp range area (tmin ‚Üí tmax)
      var area = d3.area()
        .x(function(d) { return xScale(d._date); })
        .y0(function(d) { return yScale(+d.tmin); })
        .y1(function(d) { return yScale(+d.tmax); })
        .curve(d3.curveMonotoneX);
      svg.append('path').datum(data).attr('d', area)
        .attr('fill', 'rgba(231,76,60,0.18)').attr('stroke', 'none');

      // Tmax line
      svg.append('path').datum(data)
        .attr('fill', 'none').attr('stroke', '#e74c3c').attr('stroke-width', 1.2)
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale(+d.tmax)}).curve(d3.curveMonotoneX));

      // Tmin line
      svg.append('path').datum(data)
        .attr('fill', 'none').attr('stroke', '#3498db').attr('stroke-width', 1.2)
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale(+d.tmin)}).curve(d3.curveMonotoneX));

      // Tavg line
      svg.append('path').datum(data)
        .attr('fill', 'none').attr('stroke', '#e67e22').attr('stroke-width', 1.8).attr('stroke-dasharray','4,2')
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale(+d.tavg)}).curve(d3.curveMonotoneX));

      // Legend
      var lg = svg.append('g').attr('transform', 'translate(' + (W-150) + ',0)');
      [['Tmax','#e74c3c'],['T—Å—Ä','#e67e22'],['Tmin','#3498db']].forEach(function(l,i){
        lg.append('line').attr('x1',0).attr('x2',16).attr('y1',i*14).attr('y2',i*14).attr('stroke',l[1]).attr('stroke-width',2);
        lg.append('text').attr('x',20).attr('y',i*14+4).text(l[0]).style('font-size','10px');
      });

      // Hover overlay
      addHoverOverlay(svg, data, xScale, W, H, tooltip, function(d) {
        return d.date + '<br>Tmax: ' + d.tmax + '¬∞C<br>T–º—ñ–Ω: ' + d.tmin + '¬∞C<br>T—Å–µ—Ä: ' + d.tavg + '¬∞C';
      });

    } else if (mode === 'precip') {
      // Precipitation bars + cumulative line
      var pMax = d3.max(data, function(d) { return +d.precip_day; }) * 1.1 || 10;
      var yScale = d3.scaleLinear().domain([0, pMax]).range([H, 0]);
      var cMax = d3.max(data, function(d) { return +d.precip_cumulative; }) || 100;
      var yScale2 = d3.scaleLinear().domain([0, cMax]).range([H, 0]);

      svg.append('g').call(d3.axisLeft(yScale).ticks(6)).selectAll('text').style('font-size','10px');
      svg.append('text').attr('transform','rotate(-90)').attr('y',-36).attr('x',-H/2).attr('text-anchor','middle').style('font-size','11px').text('–º–º/–¥–µ–Ω—å');

      var rAxis = d3.axisRight(yScale2).ticks(5);
      svg.append('g').attr('transform','translate('+W+',0)').call(rAxis).selectAll('text').style('font-size','10px');
      svg.append('text').attr('transform','rotate(90)').attr('y',-W-40).attr('x',H/2).attr('text-anchor','middle').style('font-size','11px').text('–º–º (—Å—É–º–º–∞)');

      var barW = Math.max(1, W / data.length - 1);
      svg.selectAll('.precip-bar').data(data).enter().append('rect')
        .attr('class','precip-bar')
        .attr('x', function(d) { return xScale(d._date) - barW/2; })
        .attr('y', function(d) { return yScale(+d.precip_day); })
        .attr('width', barW)
        .attr('height', function(d) { return H - yScale(+d.precip_day); })
        .attr('fill', 'rgba(52,152,219,0.6)');

      // Cumulative line
      svg.append('path').datum(data)
        .attr('fill','none').attr('stroke','#2c3e50').attr('stroke-width',2)
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale2(+d.precip_cumulative)}).curve(d3.curveMonotoneX));

      addHoverOverlay(svg, data, xScale, W, H, tooltip, function(d) {
        return d.date + '<br>–û—Å–∞–¥–∫–∏: ' + d.precip_day + ' –º–º<br>Œ£: ' + d.precip_cumulative + ' –º–º';
      });

    } else if (mode === 'gdd') {
      // GDD + CHU cumulative lines
      var gMax = d3.max(data, function(d) { return +d.gdd_cumulative; }) * 1.05 || 100;
      var cMax = d3.max(data, function(d) { return +d.chu_cumulative; }) * 1.05 || 100;
      var yScale = d3.scaleLinear().domain([0, gMax]).range([H, 0]);
      var yScale2 = d3.scaleLinear().domain([0, cMax]).range([H, 0]);

      svg.append('g').call(d3.axisLeft(yScale).ticks(6)).selectAll('text').style('font-size','10px');
      svg.append('text').attr('transform','rotate(-90)').attr('y',-36).attr('x',-H/2).attr('text-anchor','middle').style('font-size','11px').text('GDD');

      svg.append('g').attr('transform','translate('+W+',0)').call(d3.axisRight(yScale2).ticks(5)).selectAll('text').style('font-size','10px');
      svg.append('text').attr('transform','rotate(90)').attr('y',-W-40).attr('x',H/2).attr('text-anchor','middle').style('font-size','11px').text('CHU');

      // GDD line
      svg.append('path').datum(data)
        .attr('fill','none').attr('stroke','#e67e22').attr('stroke-width',2.5)
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale(+d.gdd_cumulative)}).curve(d3.curveMonotoneX));

      // CHU line
      svg.append('path').datum(data)
        .attr('fill','none').attr('stroke','#2ecc71').attr('stroke-width',2.5).attr('stroke-dasharray','6,3')
        .attr('d', d3.line().x(function(d){return xScale(d._date)}).y(function(d){return yScale2(+d.chu_cumulative)}).curve(d3.curveMonotoneX));

      // Legend
      var lg = svg.append('g').attr('transform','translate(10,4)');
      [['GDD','#e67e22'],['CHU','#2ecc71']].forEach(function(l,i){
        lg.append('line').attr('x1',0).attr('x2',18).attr('y1',i*16).attr('y2',i*16).attr('stroke',l[1]).attr('stroke-width',2.5);
        lg.append('text').attr('x',22).attr('y',i*16+4).text(l[0]).style('font-size','11px').attr('font-weight','bold');
      });

      addHoverOverlay(svg, data, xScale, W, H, tooltip, function(d) {
        return d.date + '<br>GDD: ' + d.gdd_cumulative + '<br>CHU: ' + d.chu_cumulative + '<br>GDD/–¥–µ–Ω—å: ' + d.gdd_day;
      });
    }
  }

  // Hover overlay helper (crosshair + tooltip)
  function addHoverOverlay(svg, data, xScale, W, H, tooltip, formatFn) {
    var bisect = d3.bisector(function(d) { return d._date; }).left;
    var focus = svg.append('line').attr('y1', 0).attr('y2', H)
      .attr('stroke', '#888').attr('stroke-width', 0.8).attr('stroke-dasharray','3,2').style('display','none');

    svg.append('rect').attr('width', W).attr('height', H).attr('fill', 'none').attr('pointer-events', 'all')
      .on('mousemove', function() {
        var x0 = xScale.invert(d3.mouse(this)[0]);
        var i = bisect(data, x0, 1);
        var d = (i >= data.length) ? data[data.length-1] : (i <= 0) ? data[0] :
          (x0 - data[i-1]._date > data[i]._date - x0 ? data[i] : data[i-1]);
        var px = xScale(d._date);
        focus.attr('x1', px).attr('x2', px).style('display', null);
        tooltip.html(formatFn(d))
          .style('display', 'block')
          .style('left', (px + 56) + 'px')
          .style('top', '20px');
      })
      .on('mouseout', function() {
        focus.style('display', 'none');
        tooltip.style('display', 'none');
      });
  }
});
</script>
